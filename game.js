var Graphics = {
  island:
    'data:image/svg+xml,<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="274px" height="274px" viewBox="0 0 274 274" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!-- Generator: Sketch 40.1 (33804) - http://www.bohemiancoding.com/sketch --><title>island</title><desc>Created with Sketch.</desc><defs><radialGradient cx="50%" cy="50%" fx="50%" fy="50%" r="90.7941016%" id="radialGradient-1"><stop stop-color="#FFBE5D" offset="0%"></stop><stop stop-color="#FFEFD7" offset="100%"></stop></radialGradient><radialGradient cx="50%" cy="50%" fx="50%" fy="50%" r="90.7941016%" id="radialGradient-2"><stop stop-color="#FAC77B" offset="0%"></stop><stop stop-color="#EEC07B" offset="100%"></stop></radialGradient><path d="M136,228 C185.705627,228 226,187.705627 226,138 C226,88.2943725 185.705627,48 136,48 C86.2943725,48 46,88.2943725 46,138 C46,187.705627 86.2943725,228 136,228 Z" id="path-3"></path></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Corsairs---Game" transform="translate(-239.000000, -365.000000)"><g id="island" transform="translate(239.000000, 365.000000)"><path d="M136,228 C185.705627,228 226,187.705627 226,138 C226,88.2943725 185.705627,48 136,48 C86.2943725,48 46,88.2943725 46,138 C46,187.705627 86.2943725,228 136,228 Z" id="Island-Copy-3" fill="#E0FDFF"></path><path d="M137,274 C212.663011,274 274,212.663011 274,137 C274,61.3369893 212.663011,0 137,0 C61.3369893,0 0,61.3369893 0,137 C0,212.663011 61.3369893,274 137,274 Z" id="Island-Copy-2" fill="url(#radialGradient-1)"></path><g id="Island-Copy"><use fill="#EEC07B" xlink:href="#path-3"></use><use fill="url(#radialGradient-2)" xlink:href="#path-3"></use></g><g id="Palm1" transform="translate(182.000000, 184.000000)"><path d="M51.2820646,51.2820646 C49.1494884,63.8226009 43,73 43,73 C43,73 36.8505116,63.8226009 34.7179354,51.2820646 C22.1773991,49.1494884 13,43 13,43 C13,43 22.1773991,36.8505116 34.7179354,34.7179354 C36.8505116,22.1773991 43,13 43,13 C43,13 49.1494884,22.1773991 51.2820646,34.7179354 C63.8226009,36.8505116 73,43 73,43 C73,43 63.8226009,49.1494884 51.2820646,51.2820646 Z" id="Combined-Shape-Copy" fill="#7CAA4E" transform="translate(43.000000, 43.000000) rotate(45.000000) translate(-43.000000, -43.000000) "></path><path d="M51.2820646,51.2820646 C49.1494884,63.8226009 43,73 43,73 C43,73 36.8505116,63.8226009 34.7179354,51.2820646 C22.1773991,49.1494884 13,43 13,43 C13,43 22.1773991,36.8505116 34.7179354,34.7179354 C36.8505116,22.1773991 43,13 43,13 C43,13 49.1494884,22.1773991 51.2820646,34.7179354 C63.8226009,36.8505116 73,43 73,43 C73,43 63.8226009,49.1494884 51.2820646,51.2820646 Z" id="Combined-Shape" fill="#99CC66"></path></g><g id="Palm2" transform="translate(4.000000, 6.000000)"><path d="M51.2820646,51.2820646 C49.1494884,63.8226009 43,73 43,73 C43,73 36.8505116,63.8226009 34.7179354,51.2820646 C22.1773991,49.1494884 13,43 13,43 C13,43 22.1773991,36.8505116 34.7179354,34.7179354 C36.8505116,22.1773991 43,13 43,13 C43,13 49.1494884,22.1773991 51.2820646,34.7179354 C63.8226009,36.8505116 73,43 73,43 C73,43 63.8226009,49.1494884 51.2820646,51.2820646 Z" id="Combined-Shape-Copy" fill="#7CAA4E" transform="translate(43.000000, 43.000000) rotate(45.000000) translate(-43.000000, -43.000000) "></path><path d="M51.2820646,51.2820646 C49.1494884,63.8226009 43,73 43,73 C43,73 36.8505116,63.8226009 34.7179354,51.2820646 C22.1773991,49.1494884 13,43 13,43 C13,43 22.1773991,36.8505116 34.7179354,34.7179354 C36.8505116,22.1773991 43,13 43,13 C43,13 49.1494884,22.1773991 51.2820646,34.7179354 C63.8226009,36.8505116 73,43 73,43 C73,43 63.8226009,49.1494884 51.2820646,51.2820646 Z" id="Combined-Shape" fill="#99CC66"></path></g><circle id="Oval-9" fill="#BA7E3D" cx="36" cy="75" r="3"></circle><circle id="Oval-9-Copy-3" fill="#BA7E3D" cx="72" cy="39" r="3"></circle><circle id="Oval-9-Copy-2" fill="#BA7E3D" cx="37" cy="24" r="3"></circle><circle id="Oval-9" fill="#BA7E3D" cx="214" cy="203" r="3"></circle><circle id="Oval-9-Copy" fill="#BA7E3D" cx="250" cy="237" r="3"></circle></g></g></g></svg>',
  tower:
    'data:image/svg+xml,<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="132px" height="132px" viewBox="0 0 132 132" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!-- Generator: Sketch 40 (33762) - http://www.bohemiancoding.com/sketch --><title>tower</title><desc>Created with Sketch.</desc><defs><path d="M66,126 C99.137085,126 126,99.137085 126,66 C126,32.862915 99.137085,6 66,6 C32.862915,6 6,32.862915 6,66 C6,99.137085 32.862915,126 66,126 Z" id="path-1"></path><mask id="mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="120" height="120" fill="white"><use xlink:href="#path-1"></use></mask><circle id="path-3" cx="66" cy="66" r="66"></circle><mask id="mask-4" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="132" height="132" fill="white"><use xlink:href="#path-3"></use></mask></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Corsairs---Game" transform="translate(-309.000000, -437.000000)"><g id="tower" transform="translate(309.000000, 437.000000)"><path d="M66,126 C99.137085,126 126,99.137085 126,66 C126,32.862915 99.137085,6 66,6 C32.862915,6 6,32.862915 6,66 C6,99.137085 32.862915,126 66,126 Z" id="Fort2-Copy" fill="#B6B6B6"></path><use id="Fort2" stroke="#878787" mask="url(#mask-2)" stroke-width="36" opacity="0.699999988" xlink:href="#path-1"></use><use id="Fort" stroke="#4D4D4D" mask="url(#mask-4)" stroke-width="34" stroke-dasharray="35" xlink:href="#path-3"></use><circle id="Flag" fill="#4D4D4D" cx="66" cy="66" r="9"></circle></g></g></g></svg>',
  ship: 'data:image/svg+xml,<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="60px" height="60px" viewBox="0 0 60 60" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!-- Generator: Sketch 40 (33762) - http://www.bohemiancoding.com/sketch --><title>Ship Copy</title><desc>Created with Sketch.</desc><defs><path d="M19.5,61.5 C19.5,61.5 40.5,51.0685425 40.5,31.5 C40.5,11.9314575 19.5,1.5 19.5,1.5 C19.5,1.5 23.5547644,14.6204474 23.5547644,31.5812978 C23.5547644,48.5421481 19.5,61.5 19.5,61.5 Z" id="path-1"></path><filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="filter-2"><feOffset dx="-5" dy="0" in="SourceAlpha" result="shadowOffsetInner1"></feOffset><feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite><feColorMatrix values="0 0 0 0 1 0 0 0 0 1 0 0 0 0 10 0 0 0.2 0" type="matrix" in="shadowInnerInner1"></feColorMatrix></filter></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Corsairs---Game" transform="translate(-345.000000, -177.000000)"><g id="Ship-Copy" transform="translate(375.000000, 207.000000) scale(-1, 1) rotate(90.000000) translate(-375.000000, -207.000000) translate(345.000000, 177.000000)"><path d="M30,60 C30,60 51,46.5685425 51,30 C51,13.4314575 46.5685425,0 30,0 C13.4314575,0 9,13.4314575 9,30 C9,46.5685425 30,60 30,60 Z" id="Oval-5" fill="#A67D62"></path><path d="M25.5,29.5 C30.4705627,29.5 34.5,25.4705627 34.5,20.5 C34.5,15.5294373 30.4705627,11.5 25.5,11.5" id="Oval-6" fill="#CBAD99" transform="translate(30.000000, 20.500000) scale(1, -1) rotate(90.000000) translate(-30.000000, -20.500000) "></path><g id="Oval-7" transform="translate(30.000000, 31.500000) rotate(90.000000) translate(-30.000000, -31.500000) "><use fill="#000000" fill-rule="evenodd" xlink:href="#path-1"></use><use fill="black" fill-opacity="1" filter="url(#filter-2)" xlink:href="#path-1"></use></g></g></g></g></svg>',
  coin: 'data:image/svg+xml,<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="24px" height="24px" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!-- Generator: Sketch 40 (33762) - http://www.bohemiancoding.com/sketch --><title>Coin Copy 2</title><desc>Created with Sketch.</desc><defs><circle id="path-1" cx="12" cy="12" r="12"></circle><mask id="mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="24" height="24" fill="white"><use xlink:href="#path-1"></use></mask></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Corsairs---Game" transform="translate(-640.000000, -598.000000)"><g id="Coins-Copy" transform="translate(521.000000, 680.500000) scale(1, -1) translate(-521.000000, -680.500000) translate(363.000000, 548.000000)"><g id="Coin-Copy-2" transform="translate(277.000000, 191.000000)"><use id="Oval-8" stroke="#FFC10E" mask="url(#mask-2)" stroke-width="6" fill="#FEE799" xlink:href="#path-1"></use><rect id="Rectangle-3" fill="#FFC10E" x="10" y="7" width="4" height="10" rx="2"></rect></g></g></g></g></svg>',
  bullet:
    'data:image/svg+xml,<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="24px" height="72px" viewBox="0 0 24 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!-- Generator: Sketch 40 (33762) - http://www.bohemiancoding.com/sketch --><title>Shot</title><desc>Created with Sketch.</desc><defs><linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#EFFEFF" offset="0%"></stop><stop stop-color="#FFFFFF" stop-opacity="0" offset="100%"></stop></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Corsairs---Game" transform="translate(-363.000000, -300.000000)"><g id="Shot" transform="translate(363.000000, 300.000000)"><rect id="Rectangle-2" fill="url(#linearGradient-1)" x="0" y="12" width="24" height="60"></rect><path d="M12,24 C18.627417,24 24,18.627417 24,12 C24,5.372583 18.627417,0 12,0 C5.372583,0 0,5.372583 0,12 C0,18.627417 5.372583,24 12,24 Z" id="Oval-2" fill="#4D4D4D"></path><circle id="Oval-3" fill="#999999" cx="14" cy="10" r="6"></circle></g></g></g></svg>',
  btn: 'data:image/svg+xml,<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="240px" height="240px" viewBox="0 0 240 240" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!-- Generator: Sketch 40 (33762) - http://www.bohemiancoding.com/sketch --><title>Oval Copy</title><desc>Created with Sketch.</desc><defs><circle id="path-1" cx="147" cy="147" r="120"></circle><mask id="mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="240" height="240" fill="white"><use xlink:href="#path-1"></use></mask></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Corsairs---Play" transform="translate(-255.000000, -986.000000)" stroke="#FFD55A" stroke-width="48" fill="#FEE799"><g id="Play" transform="translate(228.000000, 959.000000)"><use id="Oval-Copy" mask="url(#mask-2)" xlink:href="#path-1"></use></g></g></g></svg>',
  btnplay:
    'data:image/svg+xml,<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="68px" height="86px" viewBox="0 0 68 86" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!-- Generator: Sketch 40 (33762) - http://www.bohemiancoding.com/sketch --><title>Path 2</title><desc>Created with Sketch.</desc><defs></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Corsairs---Play" transform="translate(-351.000000, -1063.000000)" fill="#DCA300"><g id="Play" transform="translate(228.000000, 959.000000)"><path d="M134.648066,106.765377 C128.215017,102.476678 123,105.261796 123,112.997745 L123,181.002255 C123,188.732996 128.207026,191.528649 134.648066,187.234623 L186.679153,152.547232 C191.27463,149.48358 191.280581,144.520388 186.679153,141.452768 L134.648066,106.765377 Z" id="Path-2"></path></g></g></g></svg>',
  btnrestart:
    'data:image/svg+xml,<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="95px" height="106px" viewBox="0 0 95 106" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!-- Generator: Sketch 40 (33762) - http://www.bohemiancoding.com/sketch --><title>Group 4</title><desc>Created with Sketch.</desc><defs></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Corsairs---Scored" transform="translate(-326.000000, -1049.000000)"><g id="Play" transform="translate(228.000000, 959.000000)"><g transform="translate(147.000000, 147.000000) rotate(25.000000) translate(-147.000000, -147.000000) translate(37.000000, 37.000000)" id="Group-4"><g transform="translate(70.000000, 48.000000)"><path d="M40,102 C62.09139,102 80,84.09139 80,62 C80,39.90861 62.09139,22 40,22 C17.90861,22 -4.26325641e-14,39.90861 -4.26325641e-14,62" id="Oval-2" stroke="#DCA300" stroke-width="18" stroke-linecap="round" transform="translate(40.000000, 62.000000) scale(-1, -1) translate(-40.000000, -62.000000) "></path><path d="M41.7195655,2.03735925 C38.5607367,-0.192412691 36,1.13089825 36,5.00529707 L36,38.9947029 C36,42.8636217 38.555514,44.1960993 41.7195655,41.9626407 L65.915565,24.8830317 C68.1712482,23.2907773 68.1718616,20.7096558 65.915565,19.1169683 L41.7195655,2.03735925 Z" id="Path-2" fill="#DCA300"></path></g></g></g></g></g></svg>',
  btnswitch:
    'data:image/svg+xml,<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="107px" height="86px" viewBox="0 0 107 86" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!-- Generator: Sketch 40 (33762) - http://www.bohemiancoding.com/sketch --><title>Group 3</title><desc>Created with Sketch.</desc><defs></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Corsairs---Game" transform="translate(-322.000000, -1063.000000)" fill="#DCA300"><g id="Group-3" transform="translate(322.000000, 1063.000000)"><g id="Group-2"><rect id="Rectangle-2" x="0" y="12" width="83" height="18" rx="9"></rect><path d="M65.7195655,1.08269953 C62.5607367,-1.14707241 60,0.176238525 60,4.05063735 L60,38.0400432 C60,41.9089619 62.555514,43.2414396 65.7195655,41.007981 L89.915565,23.928372 C92.1712482,22.3361175 92.1718616,19.754996 89.915565,18.1623086 L65.7195655,1.08269953 Z" id="Path-2"></path></g><g id="Group-2-Copy" transform="translate(61.000000, 64.500000) scale(-1, 1) translate(-61.000000, -64.500000) translate(15.000000, 43.000000)"><rect id="Rectangle-2" x="0" y="12" width="83" height="18" rx="9"></rect><path d="M65.7195655,1.08269953 C62.5607367,-1.14707241 60,0.176238525 60,4.05063735 L60,38.0400432 C60,41.9089619 62.555514,43.2414396 65.7195655,41.007981 L89.915565,23.928372 C92.1712482,22.3361175 92.1718616,19.754996 89.915565,18.1623086 L65.7195655,1.08269953 Z" id="Path-2"></path></g></g></g></g></svg>',
};

var Textures = {};
var panel, playfield, money, shipDiv, fpsDiv;
var started = false;
var rotAnim = 0;
var direction = true;
var prevTs = false;
var playW = 0;
var prevBullet = 0;
var bulletFrac;
var bulletSpeed;
var shipSpeed = 100;
var fireMode = 0;
var coins = {};
var coinF = (coinL = false);
var bulletsArr = [];
var bulletsPull = [];
var bangParts = [];
var score = 0;
var level = 0;
var titres = true;
var dieing = false;
var switchOn = false;
var pause = false;
var curData;
var audio = {};
var fps = (fts = 0);
var coinsCount = 30,
  coinSize;
var stage, ship, shipLayer, renderer, imgs, cham, island, tower;
var bang, btnbg, btn, btnCont, fade, lvlText, scoreText, game, scoreCoin;
var angle = (allW = stageW = allH = cX = cY = radius = 0);
var scale = 1;
var orientation = 0;
var table = false;
var userScore = 0;
var wave1, wave2, moneyCont, circle, bg;

function post(url, data, cb, failCb) {
  var xhr = new XMLHttpRequest();
  var body = [];
  for (var i in data) {
    body.push(encodeURIComponent(i) + "=" + encodeURIComponent(data[i]));
  }
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4 && xhr.status == 200) {
      var resp = xhr.responseText;
      cb(JSON.parse(resp));
    } else if (failCb) {
      failCb();
    }
  };
  xhr.open("POST", url, true);
  xhr.send(body.join("&"));
}

function start() {
  if (titres) {
    document.body.className = "";
    titres = false;
    if (switchOn) {
      cham.fadeOut(btnrestart, 10);
      cham.fadeIn(btnplay, 10);
    }
    newGame();
  } else {
    started = true;
    cham.fadeIn(btnswitch, 10);
    cham.fadeOut(btnplay, 10);
    prevTs = false;
  }
}

function newGame() {
  bulletFrac = 400;
  bulletSpeed = 130;
  score = 0;
  level = 1;
  pause = false;
  lvlText.text = "Level " + level;
  scoreText.text = score + "";
  resetLevel();
  ge("score_share").className = "score_share";
}

function resetLevel() {
  (angle = 0), (rotAnim = 0);
  prevBullet = 0;
  fireMode = 0;
  var b;
  while ((b = bulletsArr.shift())) {
    b.done = true;
    b.alpha = 0;
    bulletsPull.push(b);
  }
  if (!direction) {
    ship.scale.x = -ship.scale.x;
    direction = true;
  }
  prevTs = false;
  coinF = 360;
  coinL = 0;
  ship.alpha = 1;
  var delay = 0;
  for (var deg in coins) {
    var c = coins[deg];
    coinF = Math.min(coinF, deg);
    coinL = Math.max(coinL, deg);
    if (!c.done) {
      continue;
    }
    c.done = false;
    setTimeout(
      (function (c) {
        return function () {
          for (var i in c.chams) {
            c.chams[i].pause();
          }
          c.chams = [];

          cham.fadeIn(c, 15);
          cham.scale(c, c.stScale, c.stScale, 15);
        };
      })(c),
      delay
    );
    delay += 20;
  }
  var tSc = tower.scale.x;
  var iSc = island.scale.x;
  cham.scale(tower, tSc * 1.15, tSc * 1.15, 15).onComplete = function () {
    cham.scale(tower, tSc, tSc, 18);
  };
  cham.scale(island, iSc * 1.08, iSc * 1.08, 10).onComplete = function () {
    cham.scale(island, iSc, iSc, 12);
  };
}

function stop() {
  if (!titres) {
    titres = true;
    dieing = false;
    ge("results").className = "results score";
    document.body.className = "results_show";
    ge("score_val").innerHTML = score;

    cham.fadeOut(btnswitch, 10);
    cham.fadeIn(btnrestart, 10);
    switchOn = true;
  }
}

function swap() {
  if (dieing || pause) {
    return false;
  }
  cham.scale(btnCont, 0.9, 0.9, 5).onComplete = function () {
    cham.scale(btnCont, 1, 1, 5);
  };
  if (!started) {
    start();
    return false;
  }
  direction = !direction;
  ship.scale.x = -ship.scale.x;
  fireMode = 3;
  //ion.sound.play("swap");
  return false;
}

function nextLevel() {
  if (!started) {
    return false;
  }
  //started = false;
  pause = true;
  level += 1;
  score += 10;
  bulletFrac = bulletFrac * 0.9;
  bulletSpeed = bulletSpeed * 1.1;
  if (level % 10 == 0) {
    shipSpeed = shipSpeed * 1.1;
  }
  lvlText.text = "Level " + level;
  scoreText.text = score + "";
  cham.scale(lvlText, 1.3, 1.3, 20).onComplete = function () {
    cham.scale(lvlText, 1, 1, 20);
  };

  cham.fadeIn(fade, 10).onComplete = function () {
    started = false;

    pause = false;

    cham.fadeOut(btnswitch, 10);
    cham.fadeIn(btnplay, 10);

    resetLevel();
    cham.fadeOut(fade, 40);
  };
}

function fireBullet() {
  var bullet = bulletsPull.shift();
  if (bullet) {
    bullet.alpha = 1;
    bullet.done = false;
  } else {
    var bullet = new PIXI.Sprite(imgs.bullet);
    stage.addChildAt(bullet, stage.getChildIndex(tower));
  }
  bullet.anchor.set(0.5, 0.5);

  var a;
  var calcAngle = (shipSpeed * 92) / bulletSpeed;
  if (fireMode == 4) {
    fireMode = 0;
    a = angle + (Math.random() * 90 - 45);
  } else if (fireMode == 3) {
    a = angle;
  } else if (fireMode == 2) {
    fireMode = 0;
    a = angle + (direction ? calcAngle : -calcAngle);
  } else {
    a = angle + (direction ? calcAngle : -calcAngle);
    a += Math.random() * 60 - 30;
  }
  fireMode += 1;

  if (a > 360) {
    a -= 360;
  }
  bullet.deg = a;
  bullet.rotation = bullet.a = radians(a);
  bullet.dist = 0;
  bullet.width = p(4);
  bullet.height = bullet.width * 3;
  bullet.x = rX(a, bullet.dist);
  bullet.y = rY(a, bullet.dist);
  bulletsArr.push(bullet);
}

function drawBullets(time) {
  for (var i in bulletsArr) {
    var bullet = bulletsArr[i];
    var a = bullet.a;
    bullet.dist += (time * bulletSpeed) / 1000;
    bullet.x = rX(a, bullet.dist);
    bullet.y = rY(a, bullet.dist);

    if (bullet.dist > 200) {
      bullet.alpha = 0;
      bulletsPull.push(bulletsArr.splice(i, 1)[0]);
      break;
    } else if (bullet.dist > 85 && bullet.dist < 95 && started && !pause) {
      var aDif = Math.abs(bullet.deg - angle);
      while (aDif > 360) {
        aDif -= 360;
      }
      if (aDif < 5 || aDif > 355) {
        cham.fadeOut(bullet, 10);
        bulletsPull.push(bulletsArr.splice(i, 1)[0]);
        //die(rX(a, bullet.dist+5), rY(a, bullet.dist+5))
        die();
        break;
      }
    }
  }
}

function die() {
  if (!started) {
    return false;
  }
  started = false;
  dieing = shipSpeed;
  if (!bang) {
    bang = new PIXI.Container();
    bang.x = 0;
    bang.y = 0;
    var colors = [0xcc1a1a, 0xffe594, 0xffc749, 0xffffff, 0xa52323, 0xfb5923];

    for (var i = 0; i < 25; i++) {
      var circ = new PIXI.Graphics();
      circ.beginFill(colors[Math.floor(Math.random() * colors.length)], 1);
      circ.drawCircle(0, 0, p(5));
      circ.endFill();
      bang.addChild(circ);
      circ.alpha = 0;
      bangParts.push(circ);
    }
    stage.addChild(bang);
  }
  var size = 1.5;
  var delay = 0;
  for (var i in bangParts) {
    var part = bangParts[i];
    var bRand = p(4);
    part.scaleTo = 0.8;

    setTimeout(
      (function (part) {
        return function () {
          part.alpha = 0;
          part.scale.set(0.01, 0.01);
          var anim = cham.scale(part, part.scaleTo, part.scaleTo, 20);
          var aX = rX(radians(angle), 100);
          var aY = rY(radians(angle), 100);
          part.x = aX + rand(bRand, true);
          part.y = aY + rand(bRand, true);
          cham.fadeIn(part, 20);
          cham.slide(part, aX + rand(bRand, true), aY + rand(bRand, true), 20);
          anim.onComplete = function () {
            var aX = rX(radians(angle), 100);
            var aY = rY(radians(angle), 100);
            cham.scale(part, 0, 0, 70);
            cham.fadeOut(part, 40);
            cham.slide(
              part,
              aX + rand(bRand, true),
              aY + rand(bRand, true),
              40
            );
          };
        };
      })(part),
      delay
    );
    delay += 30;
  }
  var oldScaleX = ship.scale.x;
  var oldScaleY = ship.scale.y;
  cham.scale(ship, -ship.scale.x * 1.5, ship.scale.y * 1.5, 15).onComplete =
    function () {
      cham.scale(ship, oldScaleX, oldScaleY, 15);
    };
  setTimeout(function () {
    cham.fadeOut(ship, 30);
  }, 800);
  setTimeout(stop, 2000);
  for (var i = 0; i < table.length; i++) {
    var row = table[i];
    if (row.current && row.score < score) {
      ge("updating").style.display = "block";
      row.score = score;
      while (i > 0) {
        i--;
        var prevRow = table[i];
        if (prevRow.score < score) {
          var oldPos = row.pos;
          row.pos = prevRow.pos;
          prevRow.pos = oldPos;
          table[i] = row;
          table[i + 1] = prevRow;
        } else {
          break;
        }
      }
      updateTable();
      break;
    }
  }
  if (score > userScore) {
    sendScore();
  } else {
    getHighScores();
  }
  ion.sound.play("explosion");
}

function updateUserScore() {
  if (!table || !table.length) return;
  for (var i = 0; i < table.length; i++) {
    if (table[i].current) {
      userScore = table[i].score;
      return;
    }
  }
}

function sendScore() {
  if (!curData) {
    ge("updating").style.display = "none";
    return;
  }
  post(
    "/api/setScore",
    {
      data: curData,
      score: score || 0,
    },
    function (result) {
      table = result.scores;
      updateUserScore();
      updateTable();
      ge("updating").style.display = "none";
      if (result.new) {
        ge("score_share").className = "score_share shown";
      }
    },
    function () {
      ge("updating").style.display = "none";
    }
  );
}

function getHighScores() {
  if (!curData) return;
  post(
    "/api/getHighScores",
    {
      data: curData,
    },
    function (result) {
      table = result.scores;
      updateUserScore();
      updateTable();
    }
  );
}

function updateTable() {
  if (table === false) return;
  var table_html = "";
  for (var i = 0; i < table.length; i++) {
    var row = table[i];
    table_html +=
      '<div class="row' +
      (row.current ? " you" : "") +
      '">' +
      '<span class="row_place">' +
      row.pos +
      ".&nbsp;&nbsp;</span>" +
      '<span class="row_name">' +
      row.name +
      "</span>" +
      '<span class="row_score">' +
      row.score +
      "</span>" +
      "</div>";
  }
  ge("scores_table").innerHTML = table_html;
}

function tryFallbackImage(img) {
  if (img.src.substr(0, 5) == "data:") {
    return (img.src = "images/" + img.filename + ".svg");
  }
  if (img.src.substr(-3, 3) == "svg") {
    return (img.src = "images/" + img.filename + ".png");
  }
  return false;
}

function loadImages(files, cb) {
  var images = {};
  var cnt = 0,
    done = 0;
  for (var i in files) {
    cnt += 1;
  }
  for (var i in files) {
    var img = new Image();
    img.src = files[i];
    img.filename = i;
    img.onload = function () {
      if (!this.width || !this.height) {
        return tryFallbackImage(this);
      }
      done += 1;
      if (done == cnt) {
        cb(images);
      }
    };
    img.onerror = function (e) {
      tryFallbackImage(this);
    };
    images[i] = img;
  }
}

function p(w) {
  return (stageW * w) / 100;
}
function radians(degrees) {
  return (degrees * Math.PI) / 180;
}

// Converts from radians to degrees.
function degrees(radians) {
  return (radians * 180) / Math.PI;
}
var a90 = radians(90);

function aX(a, pos) {
  return (pos / 100) * radius * Math.cos(a - a90);
}
function aY(a, pos) {
  return (pos / 100) * radius * Math.sin(a - a90);
}

function rX(a, pos) {
  return cX + (pos / 100) * radius * Math.cos(a - a90);
}
function rY(a, pos) {
  return cY + (pos / 100) * radius * Math.sin(a - a90);
}
function rand(num, sign) {
  if (sign) {
    return Math.floor(Math.random() * num * 2 - num);
  } else {
    return Math.floor(Math.random() * num);
  }
}

function doneCoin(coinN) {
  if (!started) return;
  var c = coins[coinN];
  if (!c || c.done) return;
  c.done = true;
  c.chams = [];

  //cham.slide(c, c.x-(c.width*3/3), c.y-(c.height*3/2), 20);
  c.chams.push(cham.fadeOut(c, 20));
  c.chams.push(cham.scale(c, c.stScale * 2, c.stScale * 2, 20));
  coinF = false;
  var has = false;
  for (var i in coins) {
    if (coins[i].done) continue;
    has = true;
    if (coinF === false) {
      coinF = i;
    }
    coinL = i;
  }
  if (!has) {
    nextLevel();
  } else {
    score += 1;
  }
  scoreText.text = score + "";

  ion.sound.play("coin2", { volume: 1 });
}

function drawMoney() {
  for (var i = 0; i < coinsCount; i += 1) {
    var deg = parseInt((i / coinsCount) * 360);
    if (deg > 360) {
      deg -= 360;
    }
    var a = radians(deg);
    if (deg && deg != 360) {
      var coin = new PIXI.Sprite(imgs.coin);
      coin.anchor.set(0.5, 0.5);
      moneyCont.addChild(coin);
      coin.height = coin.width = coinSize;
      coin.stScale = coin.scale.x;
      coin.scale.set(coin.stScale * 2, coin.stScale * 2);
      coin.alpha = 0;
      coin.done = 1;
      coins[deg] = coin;
    }
  }
}

function go(ts) {
  requestAnimationFrame(go);
  cham.update();
  if (!ts) {
    return;
  }
  if (prevTs === false) {
    prevTs = ts;
    return;
  }
  var time = ts - prevTs;
  prevTs = ts;
  drawBullets(time);

  if (started || dieing > 0) {
    var add = (time * shipSpeed) / 1000;
    if (dieing) {
      var add = (time * dieing) / 1000;
      dieing -= time / 1.5;
    }
    if (direction) {
      angle += add;
      if (angle > 360) {
        angle -= 360;
      }
      var am = angle - coinF;
      if (am > -5 && am < 5) {
        doneCoin(coinF);
      }
    } else {
      angle -= add;
      if (angle < 0) {
        angle += 360;
      }
      var am = coinL - angle;
      if (am > -5 && am < 5) {
        doneCoin(coinL);
      }
    }
    if (!prevBullet || ts - prevBullet > bulletFrac) {
      prevBullet = ts;
      fireBullet();
    }
  }

  var rAngle = radians(angle);

  ship.x = rX(rAngle, 100);
  ship.y = rY(rAngle, 100);
  ship.rotation = rAngle;

  //island.rotation -= 0.001
  //tower.rotation -= 0.001
  //tower.rotation = rAngle / 2

  renderer.render(stage);
}

function ge(id) {
  return document.getElementById(id);
}

function createWave() {
  var wave = new PIXI.Graphics();
  //wave.beginFill(0xFFFFFF)
  stage.addChild(wave);
  return wave;
}

function startWave(wave, duration) {
  wave.scale.set(1, 1);
  wave.alpha = 1;
  cham.scale(wave, 1.1, 1.1, duration).onComplete = function () {
    cham.scale(wave, 1.2, 1.2, duration - 1);
    cham.fadeOut(wave, duration).onComplete = function () {
      startWave(wave, duration);
    };
  };
}

function sizeStage() {
  allW = game.offsetWidth;
  allH = game.offsetHeight;
  allW = allW * scale;
  allH = allH * scale;
  if (!renderer) {
    renderer = PIXI.autoDetectRenderer(allW, allH);
  } else {
    renderer.resize(allW, allH);
  }
  var canvas = renderer.view;
  canvas.width = allW;
  canvas.height = allH;
  canvas.style.width = allW / scale + "px";
  canvas.style.height = allH / scale + "px";
  if (allW > allH) {
    orientation = 1;
    cX = (allW * 0.7) / 2;
    cY = allH / 2;
    if (allW * 0.7 < allH) {
      stageW = allW * 0.7;
    } else {
      stageW = allH;
    }
  } else {
    orientation = 0;
    cX = allW / 2;
    cY = (allH * 0.7) / 2;
    if (allW * 1.3 > allH) {
      stageW = allH * 0.7;
    } else {
      stageW = allW;
    }
  }
}

function posElements(first) {
  radius = p(41);

  var islandSize = p(32);
  island.x = cX;
  island.y = cY;
  island.width = islandSize;
  island.height = islandSize;

  var shipSize = p(8);
  ship.x = rX(radians(0), 100);
  ship.y = rY(radians(0), 100);
  ship.width = shipSize;
  ship.height = shipSize;

  var towerSize = p(14);
  tower.x = cX;
  tower.y = cY;
  tower.width = towerSize;
  tower.height = towerSize;

  bg.clear();
  bg.beginFill(0xffffff);
  if (orientation) {
    bg.drawRect(0, 0, allW * 0.3, allH);

    bg.y = 0;
    btnCont.y = cY;
    if (first) {
      bg.x = allW;
      btnCont.x = allW * 0.7 + allW * 0.3;
      cham.slide(bg, allW * 0.7, 0, 20, "decelerationCubed");
      cham.slide(
        btnCont,
        allW * 0.7 + (allW * 0.3) / 2,
        cY,
        30,
        "decelerationCubed"
      );
    } else {
      bg.x = allW * 0.7;
      btnCont.x = allW * 0.7 + (allW * 0.3) / 2;
    }
  } else {
    btnCont.x = cX;
    bg.x = 0;
    if (first) {
      bg.y = allH;
      btnCont.y = allH * 0.7 + allH * 0.3;
      cham.slide(bg, 0, allH * 0.7, 20, "decelerationCubed");
      cham.slide(
        btnCont,
        cX,
        allH * 0.7 + (allH * 0.3) / 2,
        30,
        "decelerationCubed"
      );
    } else {
      bg.y = allH * 0.7;
      btnCont.y = allH * 0.7 + (allH * 0.3) / 2;
    }
    bg.drawRect(0, 0, allW, allH * 0.3);
  }

  btnbg.height = btnbg.width = p(32);
  btnplay.height = p(12);
  btnplay.width = p(10);

  btnswitch.height = btnswitch.width = p(12);

  btnrestart.width = p(10);
  btnrestart.height = p(12);

  lvlText.x = p(5) + lvlText.width / 2;
  lvlText.y = p(3.5) + lvlText.height / 2;

  if (orientation) {
    scoreText.x = allW * 0.7 - p(8);
  } else {
    scoreText.x = allW - p(8);
  }
  scoreText.y = p(3.5);

  scoreCoin.x = scoreText.x + p(1);
  scoreCoin.y = scoreText.y + p(0.8);
  scoreCoin.height = scoreCoin.width = p(3.2);

  wave1.x = cX;
  wave1.y = cY;
  wave1.clear();
  wave1.beginFill(0xe0fdff);
  wave1.drawCircle(0, 0, p(25));

  /*wave2.x = cX
  wave2.y = cY
  wave2.clear()
  wave2.beginFill(0xE0FDFF)
  wave2.drawCircle(0, 0, p(25))*/

  circle.x = cX;
  circle.y = cY;

  moneyCont.x = cX;
  moneyCont.y = cY;

  circle.clear();
  circle.lineStyle(p(0.8), 0xe0fdff, 1);
  circle.drawCircle(0, 0, radius);

  coinSize = p(4);
  for (var deg in coins) {
    var coin = coins[deg];
    var a = radians(deg);
    coin.x = coin.startX = aX(a, 100);
    coin.y = coin.startY = aY(a, 100);
    coin.height = coin.width = coinSize;
  }

  fade.clear();
  fade.beginFill(0xffffff);
  if (orientation) {
    fade.drawRect(0, 0, allW * 0.7, allH);
  } else {
    fade.drawRect(0, 0, allW, allH * 0.7);
  }

  var resDiv = ge("results");
  if (orientation) {
    resDiv.style.width = "70%";
    resDiv.style.height = "100%";
  } else {
    resDiv.style.width = "100%";
    resDiv.style.height = "70%";
  }
}

function onResize() {
  sizeStage();
  posElements();
}

function main() {
  curData = (location.hash || "").substr(1);
  curData = curData.replace(/[\?&].*/g, "");

  game = ge("game");

  scale = window.devicePixelRatio || 1;
  sizeStage();
  /*if (scale > 2) {
    scale = 2
  }
  scale = 1*/
  var scaleForHighResDisplay = scale > 1;
  sizeStage();
  renderer.backgroundColor = 0xd3f7ff;
  game.appendChild(renderer.view);

  stage = new PIXI.Container();
  cham = new Charm(PIXI);

  ion.sound({
    sounds: [
      {
        name: "coin2",
      },
      {
        name: "explosion",
      },
      {
        name: "swap",
      },
    ],
    path: "sounds/",
    multiplay: true,
    volume: 1,
    preload: true,
  });

  loadImages(Graphics, function (loadedImgs) {
    imgs = {};
    for (var i in loadedImgs) {
      imgs[i] = new PIXI.Texture(new PIXI.BaseTexture(loadedImgs[i]));
    }

    var waveDuration = 100;
    wave1 = createWave();
    //startWave(wave1, waveDuration)

    /*wave2 = createWave()
    cham.scale(wave2, 1, 1, waveDuration).onComplete = function() {
      startWave(wave2, waveDuration)
    }*/

    island = new PIXI.Sprite(imgs.island);
    island.anchor.set(0.5, 0.5);
    stage.addChild(island);

    radius = p(41);
    circle = new PIXI.Graphics();
    stage.addChild(circle);

    coinSize = p(4);
    moneyCont = new PIXI.Container();
    stage.addChild(moneyCont);
    drawMoney();

    ship = new PIXI.Sprite(imgs.ship);
    ship.rotation = 0.04;

    ship.anchor.set(0.5, 0.5);
    stage.addChild(ship);

    tower = new PIXI.Sprite(imgs.tower);
    tower.anchor.set(0.5, 0.5);
    stage.addChild(tower);

    btnCont = new PIXI.Container();
    bg = new PIXI.Graphics();
    bg.interactive = true;
    bg.on("mousedown", swap);
    bg.on("touchstart", function () {
      ion.sound.play("coin2", { volume: 0 });
      swap();
    });
    stage.addChild(bg);

    btnbg = new PIXI.Sprite(imgs.btn);
    btnplay = new PIXI.Sprite(imgs.btnplay);
    btnswitch = new PIXI.Sprite(imgs.btnswitch);
    btnrestart = new PIXI.Sprite(imgs.btnrestart);
    btnbg.anchor.set(0.5, 0.5);
    btnCont.addChild(btnbg);
    btnplay.anchor.set(0.4, 0.5);
    btnplay.alpha = 1;
    btnCont.addChild(btnplay);

    btnswitch.anchor.set(0.5, 0.5);
    btnswitch.alpha = 0;
    btnCont.addChild(btnswitch);

    btnrestart.anchor.set(0.5, 0.5);
    btnrestart.alpha = 0;
    btnCont.addChild(btnrestart);

    stage.addChild(btnCont);

    lvlText = new PIXI.Text("Level 1", {
      fontFamily: "Charter, Baskerville, Georgia",
      fontSize: p(4),
      fontWeight: "bold",
      fill: 0x4d4d4d,
    });
    lvlText.anchor.set(0.5, 0.5);
    stage.addChild(lvlText);

    scoreText = new PIXI.Text("0", {
      fontFamily: "Charter, Baskerville, Georgia",
      fontSize: p(4),
      fontWeight: "bold",
      fill: 0x4d4d4d,
    });
    scoreText.anchor.set(1, 0);
    stage.addChild(scoreText);

    scoreCoin = new PIXI.Sprite(imgs.coin);
    stage.addChild(scoreCoin);

    fade = new PIXI.Graphics();
    fade.alpha = 0;
    stage.addChild(fade);

    posElements(true);
    go();

    window.onresize = onResize;
  });
  renderer.render(stage);

  getHighScores();

  ge("score_share").onclick = function () {
    TelegramGameProxy && TelegramGameProxy.shareScore();
  };

  document.onkeydown = function (e) {
    var key = e.which || e.keyCode;
    if (key == 40 || key == 38 || key == 32) {
      swap();
    } else if (key == 37 || key == 39) {
      swap();
    }
  };
}

window.onLoad = main;
if (window.loaded) {
  main();
}
